---
title: "Plot MeBr Apple Fumigation Data"
author: "John Maindonald"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Plot MeBr Apple Fumigation Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r linkfun, message=FALSE}
library(qra, quietly=TRUE)
library(ggplot2)
```

## Plot data
```{r plot}
codling <- DAAG::codling
num1 <- match(unique(codling$gp),codling$gp)
rnum <- rep(1, nrow(codling))
rnum[num1] <- 2
nnew <- rep(1:nrow(codling),rnum)
nctl <- match(num1,nnew)
codling0 <- codling[nnew,]
codling0[nctl,c('dose','tot','dead','pobs','cm','ct')] <-
  with(codling0[nctl,], cbind(rep(0,length(num1)), numcm, round(cm*numcm), 
       cm,rep(NA,length(num1)),rep(0,length(num1))))     

codling0[["logCT"]] <- log(codling0[["ct"]])
codling0[["Rep"]] <- with(codling0, qra::gpsWithin(gp, list(Cultivar,year)))
```

# Plot 1988 and 1989 data separately
```{r y1988, fig.width=7, fig.height=2.5, eval=TRUE, out.width='100%'}
graphSum(df=codling0, subSet=expression(year==1988),
                     link="cloglog", logScale=FALSE,
                     dead="dead", tot="tot", dosevar="CT", Rep="Rep",
                     fitRep=NULL, fitPanel=NULL,
                     byFacet=~Cultivar,
                     maint="Codling moth, MeBr",
                     xlab=expression(bold("CT ")*"(gm.h."*m^{-3}*")"))
```

```{r y1989, fig.width=6.5, fig.height=2.5, out.width="80%", eval=TRUE}
graphSum(df=codling0, subSet=expression(year==1989),
                     link="cloglog", logScale=FALSE,
                     dead="dead", tot="tot", dosevar="CT", Rep="Rep",
                     fitRep=NULL, fitPanel=NULL,
                     byFacet=~Cultivar,
                     maint="Codling moth, MeBr",
                     xlab=expression(bold("CT ")*"(gm.h."*m^{-3}*")"))
```
## Correct for control mortality

```{r yr88, fig.width=6.5, fig.height=2.25, out.width="80%"}
library(lattice)
cloglog <- make.link("cloglog")$linkfun
codling88  <- droplevels(subset(DAAG::codling, year==1988))
codling88 <- within(codling88, apobs <- (pobs-cm)/(1-cm))
# ctl <- glmmTMBControl(optimizer=optim,
#                       optArgs=list(method="BFGS"))
# codling88.BB2 <- glmmTMB(cbind(dead,tot-dead)~0+
#                            Cultivar/poly(ct,2)+(ct|gp),
#                            family=betabinomial(link='cloglog'),
#                            data=codling88, control=ctl)
codling88[["Rep"]] <- with(codling88, qra::gpsWithin(gp, list(Cultivar,year)))
xyplot(cloglog(apobs)~ct|Cultivar, groups=Rep, data=codling88)
```

```{r yr89, fig.asp=1, out.width="30%"}
codling89  <- droplevels(subset(DAAG::codling, year==1989))
codling89 <- within(codling89, apobs <- (pobs-cm)/(1-cm))
codling89[["Rep"]] <- with(codling89, qra::gpsWithin(gp, list(Cultivar,year)))
xyplot(cloglog(apobs)~ct|Cultivar, groups=Rep, data=codling89)
```

We now check the consistency of control mortality estimates
across and within cultivars.

```{r cm}
cmDF <- DAAG::codling[, c('year','Cultivar',
                         'dead','tot', 'cm','numcm','gp')]
cmDF$Rep <- qra::gpsWithin(cmDF$gp,cmDF$Cultivar)
cmDF <- cmDF[match(unique(cmDF$gp),cmDF$gp),]
cmDF$cmdead <- with(cmDF, round(numcm*cm))
cmDF88 <- subset(cmDF, year==1988)
cmDF89 <- subset(cmDF, year==1989)
ctl <- glmmTMBControl(optimizer=optim,
                      optArgs=list(method="BFGS"))
cm88.TMB <- glmmTMB(cbind(cmdead,numcm-cmdead)~Cultivar,
               family=betabinomial(link='logit'), 
               subset(cmDF,year==1988))
cm88.glm <- glm(cbind(cmdead,numcm-cmdead)~Cultivar, 
               family=quasibinomial(link='logit'), 
               data=subset(cmDF,year==1988))
cm89.TMB <- glmmTMB(cbind(cmdead,numcm-cmdead)~Cultivar, 
                   family=betabinomial(link='logit'), 
                   data=subset(cmDF,year==1989))
cm89.glm <- glm(cbind(cmdead,numcm-cmdead)~Cultivar, 
                family=quasibinomial(link='logit'), 
                data=subset(cmDF,year==1989))
```

The following shows the range of estimated variance multipliers
for the fit with a betabinomial error, and compares it with 
the "dispersion" estimate for a `glm()` fit with quasibinomial 
error.

```{r varmult}
mults <- matrix(nrow=2, ncol=6)
dimnames(mults) <- list(c('88','89'),c('phi','nmin','nmax',
                                       'Phimin','Phimax','PhiGLM'))
phi88 <- sigma(cm88.TMB)
nrange <- range(subset(cmDF,year==1988)$numcm)
Phirange <- 1+phi88^{-1}*(nrange-1)
mults['88',] <- c(phi88, nrange, Phirange, 
                  summary(cm88.glm)$dispersion)
phi89 <- sigma(cm89.TMB)
nrange <- range(subset(cmDF,year==1989)$numcm)
Phirange <- 1+phi89^{-1}*(nrange-1)
mults['89',] <- c(phi89, nrange, Phirange, 
                  summary(cm89.glm)$dispersion)
round(mults,2)
```

The estimates of $\phi$ (`sigma`) are 1988: `r round(phi88^-1,6)`; and 1989: `r round(phi89^-1,5)` .  Although very small, multiplication by
values of $n$ that are in the thousands lead to a variance multiplier
that is noticeably greater than 1.0 on 1988, and substantial ijn 1989.

Now fit a model for the 1989 control mortality data that allows the 
betabinomial dispersion parameter to be different for the
different cultivars.  The `dispformula` changes from the default
`dispformula = ~1` to `dispformula = ~0+Cultivar`.  (Use of
`dispformula = ~Cultivar`, equivalent to `dispformula = ~1+Cultivar`,
would give a parameterization that is less convenient for
present purposes.)
```{r more-on-cm89}
cm89d.TMB <- update(cm89.TMB, dispformula=~0+Cultivar,    
                   control=ctl)
nranges <- with(subset(cmDF,year==1989),
                sapply(split(numcm,Cultivar),range))
phi89d <- exp(coef(summary(cm89d.TMB))$disp[,1])
Phiranges <- 1+t(nranges-1)*phi89d^-1
colnames(Phiranges) <- c("Min","Max")
round(Phiranges,2)
```
Because the model formula allowed different values for 
different observations, the function `sigma()` could no
longer be used to extract what are now three different
dispersion parameters.  Instead, it was necessary to
specify `coef(summary(cm89d.TMB))$disp[,1]`, and then
(because a logarithmic link function is used) take the 
exponent.  (Use of `coef(summary(cm89d.TMB))$disp` gives,
on the logarithmic link scale, standard errors, z values,
and $p$-values.)

```{r cmDF88-cults}
cults <- unique(cmDF88$Cultivar)
mat <- matrix(nrow=length(cults),ncol=5)
dimnames(mat) <- list(cults,
                      c("phi","nmin","nmax","PhiMin","PhiMax"))
for(cult in cults){
df <- subset(cmDF88, cult==Cultivar)
obj <- glmmTMB(cbind(dead,tot-dead)~1,       
               family=betabinomial(link='logit'), data=df)
phi <- sigma(obj)
nrange <- range(df$numcm)
mat[cult,] <- c(phi, nrange, 1+(nrange-1)*phi^-1)
}
round(mat,1)
```

